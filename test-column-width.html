<!DOCTYPE html>
<html>
<head>
    <title>Test Column Width Saving</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .form-column {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            display: flex;
            flex-direction: column;
        }
        .column-header {
            background: #f5f5f5;
            padding: 5px;
            margin-bottom: 10px;
        }
        .column-actions {
            margin-top: 5px;
        }
        .test-row {
            display: flex;
            margin: 20px 0;
            border: 2px solid #000;
            padding: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
        }
        .result {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background: #ffe8e8;
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <h1>Test Column Width Saving</h1>
    
    <div class="test-section">
        <h2>Test 1: Column Width Functions</h2>
        <p>Test the column width changing and saving functionality</p>
        
        <div class="test-row" id="test-row-1">
            <div class="form-column" data-column-id="col-1" style="flex: 1;">
                <div class="column-header">
                    <span class="column-title">Column 1</span>
                    <div class="column-actions">
                        <select class="column-width-selector" onchange="changeColumnWidth('col-1', this.value)">
                            <option value="1" selected>Auto</option>
                            <option value="0.25">25% (1/4)</option>
                            <option value="0.33">33.33% (1/3)</option>
                            <option value="0.5">50% (1/2)</option>
                            <option value="0.75">75% (3/4)</option>
                        </select>
                    </div>
                </div>
                <div>Content 1</div>
            </div>
            
            <div class="form-column" data-column-id="col-2" style="flex: 1;">
                <div class="column-header">
                    <span class="column-title">Column 2</span>
                    <div class="column-actions">
                        <select class="column-width-selector" onchange="changeColumnWidth('col-2', this.value)">
                            <option value="1" selected>Auto</option>
                            <option value="0.25">25% (1/4)</option>
                            <option value="0.33">33.33% (1/3)</option>
                            <option value="0.5">50% (1/2)</option>
                            <option value="0.75">75% (3/4)</option>
                        </select>
                    </div>
                </div>
                <div>Content 2</div>
            </div>
        </div>
        
        <button onclick="testBuildLayout()">Test Build Layout Structure</button>
        <button onclick="testLoadLayout()">Test Load Layout</button>
        <button onclick="resetTest()">Reset Test</button>
        
        <div id="test-result-1" class="result" style="display: none;"></div>
    </div>

    <script>
        // Mock global variables
        let formModified = false;
        let autoSaveTimeout = null;
        
        // Mock functions from form builder
        function markFormAsModified() {
            formModified = true;
            console.log('Form marked as modified');
        }
        
        function saveForm(silent) {
            console.log('Save form called, silent:', silent);
            return Promise.resolve({success: true});
        }
        
        // Actual function from form builder
        function changeColumnWidth(columnId, flexValue) {
            const column = $(`.form-column[data-column-id="${columnId}"]`);
            column.css('flex', flexValue);
            
            // Also update the column width selector to reflect the change
            column.find('.column-width-selector').val(flexValue);
            
            // Mark form as modified to enable save
            markFormAsModified();
            
            // Optional: Auto-save after a short delay
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
            }
            autoSaveTimeout = setTimeout(function() {
                saveForm(true); // Silent save
            }, 2000);
        }
        
        // Test function to build layout structure
        function buildLayoutStructure() {
            const rows = [];

            $('#test-row-1').each(function() {
                const rowElement = $(this);
                const rowId = 'test-row-1';
                const columns = [];

                rowElement.find('.form-column').each(function() {
                    const columnElement = $(this);
                    const columnId = columnElement.data('column-id');
                    const fields = [];

                    columns.push({
                        id: columnId,
                        width: columnElement.css('flex') || '1',
                        fields: fields
                    });
                });

                rows.push({
                    id: rowId,
                    columns: columns
                });
            });

            return { rows: rows };
        }
        
        function testBuildLayout() {
            const layout = buildLayoutStructure();
            const result = $('#test-result-1');
            
            result.removeClass('error').show();
            result.html('<h3>Build Layout Result:</h3><pre>' + JSON.stringify(layout, null, 2) + '</pre>');
            
            // Check if widths are correctly captured
            const col1Width = layout.rows[0].columns[0].width;
            const col2Width = layout.rows[0].columns[1].width;
            
            if (col1Width && col2Width) {
                result.append('<p>✅ Column widths captured: Col1=' + col1Width + ', Col2=' + col2Width + '</p>');
            } else {
                result.addClass('error').append('<p>❌ Column widths not captured properly</p>');
            }
        }
        
        function testLoadLayout() {
            // Test loading a layout with specific widths
            const testLayout = {
                rows: [{
                    id: 'test-row-1',
                    columns: [{
                        id: 'col-1',
                        width: '0.33',
                        fields: []
                    }, {
                        id: 'col-2', 
                        width: '0.66',
                        fields: []
                    }]
                }]
            };
            
            // Apply the layout
            testLayout.rows[0].columns.forEach(column => {
                const columnElement = $(`.form-column[data-column-id="${column.id}"]`);
                columnElement.css('flex', column.width);
                columnElement.find('.column-width-selector').val(column.width);
            });
            
            const result = $('#test-result-1');
            result.removeClass('error').show();
            result.html('<h3>Load Layout Test:</h3>');
            result.append('<p>Applied widths: Col1=0.33 (33%), Col2=0.66 (66%)</p>');
            
            // Verify the layout was applied
            const actualCol1Width = $('.form-column[data-column-id="col-1"]').css('flex');
            const actualCol2Width = $('.form-column[data-column-id="col-2"]').css('flex');
            const actualCol1Select = $('.form-column[data-column-id="col-1"] .column-width-selector').val();
            const actualCol2Select = $('.form-column[data-column-id="col-2"] .column-width-selector').val();
            
            result.append('<p>Actual CSS: Col1=' + actualCol1Width + ', Col2=' + actualCol2Width + '</p>');
            result.append('<p>Select values: Col1=' + actualCol1Select + ', Col2=' + actualCol2Select + '</p>');
            
            if (actualCol1Width === '0.33' && actualCol2Width === '0.66' && 
                actualCol1Select === '0.33' && actualCol2Select === '0.66') {
                result.append('<p>✅ Layout loaded correctly!</p>');
            } else {
                result.addClass('error').append('<p>❌ Layout not loaded correctly</p>');
            }
        }
        
        function resetTest() {
            $('.form-column').css('flex', '1');
            $('.column-width-selector').val('1');
            $('#test-result-1').hide();
            formModified = false;
        }
        
        // Initialize
        $(document).ready(function() {
            console.log('Column width test ready');
        });
    </script>
</body>
</html>
